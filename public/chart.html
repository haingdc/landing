<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preload" as="image" href="/img/fallback.jpeg" />
  <script type="importmap">
    {
      "imports": {
        "temporal-polyfill": "https://esm.sh/temporal-polyfill@0.3.0?pin=v1&dev",
        "d3": "https://cdn.jsdelivr.net/npm/d3@7/+esm"
      }
    }
  </script>
  <title>Landing</title>
  <style>
    html {
      /* inline background noise. No network request & failure & white flash at page load */
      background-image: url(data:image/png;base64,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);
      background-color: rgb(1 5 19);
      font-family: arial, sans-serif;
    }

    body {
      overflow-x: hidden;
      /* 1D mode places images horizontally and exceeds viewport width */
      margin: 0;
    }

    #root {
      max-width: 1200px;
      margin: auto;
      display: grid;
      grid-template-columns: auto 1fr;
      grid-column-gap: 24px;
      grid-row-gap: 28px;
    }

    .section-header  {
      font-size: 32px;
      line-height: 1.6;
      color: hsl(0, 0%, 100%);
      text-transform: uppercase;
    }
    .current-week-container {
      grid-column: 1 / 2;
      .content {
        border: 1px solid hsl(0, 0%, 100%);
        width: 700px;
        height: 400px;
      }
      
    }
    .weekly-progress-container {
      grid-row: 2 / 3;
      grid-column: 1 / 3;
      .content {
        border: 1px solid hsl(0, 0%, 100%);
      }
    }
    .weekly-progress-table {
      color: hsl(0, 0%, 100%);
      border-collapse: collapse;
      border-spacing: 0;
      font-family: arial, sans-serif;
      table-layout: fixed;
      width: 100%;
      border-color: inherit;
      border-collapse: collapse;

      thead {
        background-color: hsl(1.5, 78%, 56%);
      }
      tr {
        border-bottom: 1px solid lightgray;
      }
      th {
        border-bottom: 1px solid lightgray;
        border-right: 1px solid lightgray;
        padding: 12px 8px;
        text-align: left;
        font-size: 16px;
      }
      td {
        padding: 12px 8px;
      }
    }
  </style>
  <link rel="shortcut icon" type="image/svg+xml" href="/favicon.ico" />
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <div id="root">
    <section class="current-week-container">
      <header class="section-header">Thành tích tuần này </header>
      <div class="content"></div>
    </section>
    <section class="weekly-progress-container">
      <header class="section-header">Tiến độ hàng tuần</header>
      <div class="content"></div>
    </section>
  </div>
  <script type="module">
    /// <reference lib="dom" />
    import * as d3 from "d3";
    import { Temporal } from 'temporal-polyfill'
    import getColor from './scripts/getColor.js'
    import { unstable_delaySpin } from './scripts/unstable_spinDelay.js'
    import { delay } from './scripts/delay.js'
    import { formatDateRange } from './scripts/unstable_formatDateRanges.js'

    // === Constants
    const targetWordsDaily = 300
    const listType = 'week'
    const weekdays = [
      "Thứ hai", "Thứ ba", "Thứ tư",
      "Thứ năm", "Thứ sáu", "Thứ bảy", "Chủ nhật"
    ];

    let spinner = null
    const app = document.getElementById('root')
    const currentweeklyParent = app.querySelector('.current-week-container .content')
    let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg")
    svg.classList.add('current-week-chart')
    svg.setAttribute('width', '700')
    svg.setAttribute('height', '400')

    try {
      const params = new URLSearchParams({ listType })
      const fetchPromise = fetch(`./api/dayrecord?${params.toString()}`)
      const state = await unstable_delaySpin(fetchPromise, { delay: 500 })
      if (state === 'show_the_spin') {
        spinner = document.createElement('img')
        spinner.src = '/img/fallback.jpeg'
        spinner.classList.add('loader')
        app.append(spinner)
        await delay(2000)
      }
      const response = await fetchPromise
      const dayRecords = await response.json()
      const newData = [null, null, null, null, null, null, null] // 7 days a week
      let today = Temporal.Now.plainDateISO('Asia/Ho_Chi_Minh');
      for (let i = 0; i < dayRecords.length && i < 7; i++) {
        const d = dayRecords[i]
        const { dayOfWeek } = Temporal.PlainDate.from(d.date)
        const ratioDailyTarget = d.net_words_change / targetWordsDaily * 100
        newData[dayOfWeek - 1] = {
          source: d,
          id: d.id,
          w: 400,
          h: 400,
          prompt: d.net_words_change,
          header: getDateName(d.date),
          ratioDailyTarget,
          value: d.net_words_change
        }
      }
      for (let i = 0; i < 7; i++) {
        const d = newData[i]
        if (d === null) {
          newData[i] = {
            source: null,
            id: i,
            w: 400,
            h: 400,
            prompt: 0,
            header: weekdays[i],
            ratioDailyTarget: today.dayOfWeek === i + 1 ? 0 : undefined,
            value: 0,
          }
        }
      }
      if (spinner && spinner.parentElement) {
        app.removeChild(spinner)
      }
      console.log(newData)
      currentweeklyParent.append(svg)

      svg = d3.select("svg");
      const width = +svg.attr("width");
      const height = +svg.attr("height");
      const margin = { top: 40, right: 30, bottom: 50, left: 60 };

      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // scale
      const x = d3.scaleBand()
        .domain(newData.map(d => d.header))
        .range([0, chartWidth])
        .padding(0.3);

      const y = d3.scaleLinear()
        .domain([0, d3.max(newData, d => d.value) || targetWordsDaily]) // đảm bảo trục y luôn có giá trị tối đa
        .nice()
        .range([chartHeight, 0]);

      // trục
      g.append("g")
        .attr("transform", `translate(0,${chartHeight})`)
        .call(d3.axisBottom(x))
        .attr('class', 'x-axis')
        .style('color', 'white');

      g.append("g")
        .call(d3.axisLeft(y).tickFormat(d => `${d} từ`))
        .attr('class', 'y-axis')
        .style('color', 'white');

      // offset giả lập 3D
      const dx = 12, dy = 12;

      // vẽ từng cột
      newData.forEach(d => {
        const barX = x(d.header);
        const barY = y(d.value);
        const barW = x.bandwidth();
        const barH = chartHeight - barY;
        console.log({ barX, barY, barW, barH, ratioDailyTarget: d.ratioDailyTarget })
        const { light, saturation, hue } = getColor(d.ratioDailyTarget);

        // mặt trước (màu nhạt)
        g.append("rect")
          .attr("x", barX)
          .attr("y", barY)
          .attr("width", barW)
          .attr("height", barH)
          .attr("fill", `hsl(${hue}deg ${saturation}% ${light * 1.2}%)`);

        // mặt trên (màu nhạt trung bình)
        g.append("polygon")
          .attr("points", `
          ${barX},${barY}
          ${barX + dx},${barY - dy}
          ${barX + barW + dx},${barY - dy}
          ${barX + barW},${barY}
        `)
          .attr("fill", `hsl(${hue}deg ${saturation}% ${light}%)`);

        // mặt bên (màu đậm nhất)
        g.append("polygon")
          .attr("points", `
          ${barX + barW},${barY}
          ${barX + barW + dx},${barY - dy}
          ${barX + barW + dx},${barY - dy + barH}
          ${barX + barW},${barY + barH}
        `)
          .attr("fill", `hsl(${hue}deg ${saturation}% ${light * 0.75}%)`);

      });
    } catch (err) {
      console.error(err)
    }

    function getDateName(dateStr) {
      const date = Temporal.PlainDate.from(dateStr);
      const dayName = weekdays[date.dayOfWeek /* range 1-7*/ - 1];
      return dayName
    }


    const weeklyProgressContent = app.querySelector('.weekly-progress-container .content')
    try {
      const weeklyProgressPromise = fetch(`./api/weeklyprogress`)
      const response = await weeklyProgressPromise
      const weeklyProgress = await response.json()
      const headers = ['Tuần', 'Số lượng từ', 'avg/ngày', 'số lượng ngày viết trong tuần']

      const table = document.createElement('table');
      table.classList.add('weekly-progress-table')
      let thead = document.createElement('thead'),
          tbody = document.createElement('tbody'),
          trHead = document.createElement('tr')
      {
        let ths = []
        for (let i = 0; i < headers.length; i++) {  // table headers
          const th = document.createElement('th')
          th.textContent = headers[i]
          ths.push(th)
        }
        for (const week of weeklyProgress) { // table rows
          const tr = document.createElement('tr')
          let cellTuan = document.createElement('td'),
              cellSoLuongTu = document.createElement('td'),
              cellAvgNgay = document.createElement('td'),
              cellSoNgayViet = document.createElement('td')
          cellTuan.textContent = formatDateRange(week.week_start, week.week_end)
          cellSoLuongTu.textContent = week.total_net_words_a_week
          cellAvgNgay.textContent = week.avg_daily_net_words_a_week_so_far
          cellSoNgayViet.textContent = week.writing_days
          tr.append(cellTuan, cellSoLuongTu, cellAvgNgay, cellSoNgayViet)
          tbody.append(tr)
        }
        trHead.append(...ths) 
        thead.append(trHead)
        table.append(thead, tbody)
      }
      weeklyProgressContent.append(table)
    } catch (err) {
      console.error(err)
    }

  </script>
</body>

</html>